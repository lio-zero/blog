# ä½¿ç”¨ node-cron åœ¨ Node.js ä¸­è°ƒåº¦ä»»åŠ¡

æ²¡æœ‰ä¸€ä¸ªå¼€å‘äººå‘˜æ„¿æ„æŠŠæ‰€æœ‰æ—¶é—´éƒ½èŠ±åœ¨ç¹ççš„ä»»åŠ¡ä¸Šï¼Œæ¯”å¦‚ç³»ç»Ÿç»´æŠ¤å’Œç®¡ç†ã€æ—¥å¸¸æ•°æ®åº“å¤‡ä»½ä»¥åŠå®šæœŸä¸‹è½½æ–‡ä»¶å’Œç”µå­é‚®ä»¶ã€‚ä½ æ›´æ„¿æ„ä¸“æ³¨äºå¯Œæœ‰æˆæ•ˆçš„å·¥ä½œï¼Œè€Œä¸æ˜¯è·Ÿè¸ªè¿™äº›çƒ¦äººçš„çäº‹ä½•æ—¶éœ€è¦å®Œæˆã€‚

è¿™æ—¶å°±éœ€è¦ä½¿ç”¨åˆ°**ä»»åŠ¡è°ƒåº¦**ï¼Œå®ƒå°†å¸®åŠ©æ‚¨è§£å†³è¿™æ ·çš„é—®é¢˜ã€‚

**ä»»åŠ¡è°ƒåº¦**ä½¿æ‚¨èƒ½å¤Ÿè®¡åˆ’ä»»æ„ä»£ç ï¼ˆæ–¹æ³•/å‡½æ•°ï¼‰å’Œå‘½ä»¤åœ¨å›ºå®šæ—¥æœŸå’Œæ—¶é—´ã€é‡å¤é—´éš”æˆ–æŒ‡å®šé—´éš”åæ‰§è¡Œä¸€æ¬¡ã€‚åœ¨ Linux æ“ä½œç³»ç»Ÿä¸­ï¼Œä»»åŠ¡è°ƒåº¦é€šå¸¸ç”±è¯¸å¦‚ cron ä¹‹ç±»çš„å®ç”¨ç¨‹åºæœåŠ¡åœ¨æ“ä½œç³»ç»Ÿçº§åˆ«å¤„ç†ã€‚

åœ¨ Node.js åº”ç”¨ç¨‹åºä¸­ï¼Œç±»ä¼¼äº cron çš„åŠŸèƒ½ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ [node-cron](https://github.com/kelektiv/node-cron) è¿™æ ·çš„åŒ…å®ç°ã€‚æ­£å¦‚å¼€å‘è€…æ‰€ä»‹ç»çš„ï¼Œ**[node-cron](https://www.npmjs.com/package/node-cron)** æ˜¯åŸºäº GNU crontab çš„ node.js çº¯ JavaScript ä¸­çš„å¾®å‹ä»»åŠ¡è°ƒåº¦å™¨ã€‚

crontab æ˜¯ Linux ç³»ç»Ÿçš„å®šæ—¶ä»»åŠ¡æ‰§è¡Œå™¨ã€‚cron çš„æ“ä½œç”± [crontab](https://www.gnu.org/software/mcron/manual/html_node/Crontab-file.html) æ–‡ä»¶é©±åŠ¨ï¼Œè¯¥æ–‡ä»¶æ˜¯ä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«å¯¹ cron å®ˆæŠ¤ç¨‹åºçš„æŒ‡ä»¤ã€‚`node-cron` æ¨¡å—å…è®¸æˆ‘ä»¬ä½¿ç”¨å®Œæ•´çš„ crontab è¯­æ³•åœ¨ Node ä¸­è°ƒåº¦ä»»åŠ¡ã€‚

> ğŸ‰**æ¨èå·¥å…·**
>
> [crontab ç¼–è¾‘å™¨](https://crontab.guru/)ï¼šåœ¨çº¿å·¥å…·å¯ä»¥å¯è§†åŒ–ç”Ÿæˆ crontab çš„é…ç½®æ–‡ä»¶ã€‚

crontab è¯­æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š

```txt
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ second (å¯é€‰)
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ åˆ†é’Ÿ (minuteï¼Œ0 - 59)
â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å°æ—¶ (hourï¼Œ0 - 23)
â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€ ä¸€ä¸ªæœˆä¸­çš„ç¬¬å‡ å¤© (day of monthï¼Œ1 - 31)
â”‚ â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€ æœˆä»½ (monthï¼Œ1 - 12)
â”‚ â”‚ â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€ ä¸€ä¸ªæ˜ŸæœŸä¸­æ˜ŸæœŸå‡  (day of weekï¼Œ0 - 6) æ³¨æ„ï¼šæ˜ŸæœŸå¤©ä¸º 0
â”‚ â”‚ â”‚ â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ â”‚ â”‚ â”‚
* * * * * *
```

å•ä¸ªæ˜Ÿå·çš„è¡Œä¸ºç±»ä¼¼äºé€šé…ç¬¦ã€‚è¿™æ„å‘³ç€è¯¥ä»»åŠ¡å°†é’ˆå¯¹è¯¥æ—¶é—´å•ä½çš„æ¯ä¸ªå®ä¾‹è¿è¡Œã€‚äº”ä¸ªæ˜Ÿå·ï¼ˆ`* * * * *`ï¼‰è¡¨ç¤º crontab é»˜è®¤æ¯åˆ†é’Ÿè¿è¡Œä¸€æ¬¡ã€‚

æ˜Ÿå·å¤„çš„æ•°å­—å°†è¢«è§†ä¸ºè¯¥æ—¶é—´å•ä½çš„å€¼ã€‚å…è®¸æ‚¨å°†ä»»åŠ¡å®‰æ’ä¸ºæ¯å¤©ã€æ¯å‘¨æˆ–æ›´å¤æ‚çš„æ—¶é—´ã€‚

å°†ä¸Šé¢çš„å›¾å½¢è¡¨ç¤ºé‡æ–°ç¼–å†™æˆè¡¨æ ¼ï¼Œå…è®¸çš„ cron å€¼åŒ…æ‹¬ä»¥ä¸‹å†…å®¹ã€‚

| **å­—æ®µ**           | **å€¼**                                 |
| ------------------ | -------------------------------------- |
| `second`           | 0-59                                   |
| `minute`           | 0-59                                   |
| `hour`             | 0-23                                   |
| `day of the month` | 1-31                                   |
| `month`            | 1-12ï¼ˆæˆ–æœˆä»½ç®€å†™ Janã€Feb...ï¼‰         |
| `day of the week`  | 0-7ï¼ˆæˆ– Janã€Feb...ï¼Œ0 æˆ– 7 æ˜¯æ˜ŸæœŸæ—¥ï¼‰ |

ä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹å®ƒçš„ä¸€äº›ç”¨æ³•å’Œç”¨ä¾‹ã€‚

## ä½¿ç”¨ node-cron

ä½¿ç”¨ `npm` å®‰è£… `node-cron` æ¨¡å—ã€‚

```bash
npm i node-cron
```

### è¯­æ³•

```js
cron.schedule(cronExpression: string, task: Function, options: Object)
```

### é€‰é¡¹

- `scheduled`ï¼šä¸€ä¸ªå¸ƒå°”å€¼ï¼ˆ`boolean`ï¼‰ï¼Œç”¨äºè®¾ç½®åˆ›å»ºçš„ä»»åŠ¡æ˜¯å¦å·²å®‰æ’ï¼ˆé»˜è®¤å€¼ä¸º `true`ï¼‰ã€‚
- `timezone`ï¼šç”¨äºä»»åŠ¡è°ƒåº¦çš„æ—¶åŒºã€‚æœ‰å…³æœ‰æ•ˆå€¼ï¼Œå¯å‚è€ƒ [moment-timezone](https://momentjs.com/timezone)ã€‚

çœ‹çœ‹ä¸‹é¢çš„ä¾‹å­ã€‚

```js
const cron = require('node-cron')

cron.schedule('5 * * * * *', () => {
  console.log('æ¯åˆ†é’Ÿåœ¨ç¬¬ 5 ç§’è¿è¡Œä»»åŠ¡')
})
```

æ—¶é—´è§„èŒƒçš„ä½ç½® 2ã€3ã€4ã€5 å’Œ 6 ä¸­çš„æ˜Ÿå·ï¼ˆ`*`ï¼‰ç±»ä¼¼äºç”¨äºæ—¶é—´åˆ’åˆ†çš„æ–‡ä»¶ glob æˆ–é€šé…ç¬¦ï¼›å®ƒä»¬åˆ†åˆ«æŒ‡å®š**æ¯åˆ†é’Ÿ**ã€**æ¯å°æ—¶**ã€**æ¯æœˆçš„æ¯ä¸€å¤©**ã€**æ¯æœˆå’Œæ¯å‘¨çš„æ¯ä¸€å¤©**ã€‚

ä»¥ä¸‹ä»£ç å°†åœ¨æ¯å¤©å‡Œæ™¨ 5:30 è¿è¡Œã€‚

```js
const cron = require('node-cron')

cron.schedule('30 5 * * *', () => {
  console.log('æ¯å¤©å‡Œæ™¨ 5:30 è¿è¡Œä»»åŠ¡')
})
```

## ä»»åŠ¡è°ƒåº¦æç¤ºå’ŒæŠ€å·§

ç°åœ¨æˆ‘ä»¬å·²ç»äº†è§£äº†åŸºæœ¬çŸ¥è¯†ï¼Œè®©æˆ‘ä»¬åšä¸€äº›æ›´æœ‰è¶£çš„äº‹æƒ…ã€‚

å‡è®¾æ‚¨å¸Œæœ›åœ¨æ¯å‘¨äº”ä¸‹åˆ 4 ç‚¹è¿è¡Œä¸€é¡¹ç‰¹å®šä»»åŠ¡ã€‚ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š

```js
const cron = require('node-cron')

cron.schedule('0 16 * * friday', () => {
  console.log('æ¯å‘¨äº”ä¸‹åˆ 16:00 è¿è¡Œä»»åŠ¡')
})
```

æˆ–è€…ï¼Œæ‚¨å¯èƒ½éœ€è¦æ¯ä¸ªå­£åº¦ï¼ˆ1 æœˆã€4 æœˆã€7 æœˆå’Œ 10 æœˆï¼‰è¿è¡Œä¸€æ¬¡æ•°æ®åº“å¤‡ä»½ã€‚crontab è¯­æ³•æ²¡æœ‰**ä¸€ä¸ªæœˆçš„æœ€åä¸€å¤©**é€‰é¡¹ï¼Œå› æ­¤æ‚¨å¯ä»¥ä½¿ç”¨**ä¸‹ä¸ªæœˆçš„ç¬¬ä¸€å¤©**ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚

```js
const cron = require('node-cron')

cron.schedule('2 3 1 1,4,7,10 *', () => {
  console.log('åœ¨æ¯ä¸ªå­£åº¦ç¬¬ä¸€å¤©çš„ 03:02 è¿è¡Œä»»åŠ¡')
})
```

ä¸‹é¢æ˜¾ç¤ºçš„ä»»åŠ¡ä»ä¸Šåˆ 10 ç‚¹åˆ°ä¸‹åˆ 6 ç‚¹ï¼Œæ¯å°æ—¶ 5 åˆ†é’Ÿè¿è¡Œä»»åŠ¡ã€‚

```js
const cron = require('node-cron')

cron.schedule('5 10-18 * * *', () => {
  console.log('ä»ä¸Šåˆ 10 ç‚¹åˆ°ä¸‹åˆ 18 ç‚¹ï¼Œæ¯å°æ—¶ç¬¬ 5 åˆ†é’Ÿè¿è¡Œä»»åŠ¡')
})
```

åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæ‚¨å¯èƒ½éœ€è¦æ¯ä¸¤å°æ—¶ã€ä¸‰å°æ—¶æˆ–å››å°æ—¶è¿è¡Œä¸€æ¬¡ä»»åŠ¡ã€‚æ‚¨å¯ä»¥é€šè¿‡å°†å°æ—¶æ•°é™¤ä»¥æ‰€éœ€çš„æ—¶é—´é—´éš”æ¥å®Œæˆæ­¤æ“ä½œï¼Œä¾‹å¦‚ï¼Œæ¯å››å°æ—¶ `*4`ï¼Œæˆ–åœ¨ä¸Šåˆ 12 ç‚¹åˆ°ä¸‹åˆ 12 ç‚¹ä¹‹é—´æ¯ä¸‰å°æ—¶è¿è¡Œ `0-12/3`ã€‚

åˆ†é’Ÿä¹Ÿå¯ä»¥ç”¨åŒæ ·çš„æ–¹æ³•åˆ’åˆ†ã€‚ä¾‹å¦‚ï¼Œ`minutes` ä½ç½®çš„è¡¨è¾¾å¼ä¸º `*/10`ï¼Œè¡¨ç¤º**æ¯ 10 åˆ†é’Ÿè¿è¡Œä¸€æ¬¡ä»»åŠ¡**ã€‚

ä¸‹é¢çš„ä»»åŠ¡åœ¨ä¸Šåˆ 8 ç‚¹åˆ°ä¸‹åˆ 5:58 ä¹‹é—´æ¯ä¸¤å°æ—¶åçš„æ¯ 5 åˆ†é’Ÿè¿è¡Œä¸€æ¬¡ä»»åŠ¡ã€‚

```js
const cron = require('node-cron')

cron.schedule('*/5 8-18/2 * * *', () => {
  console.log('ä»ä¸Šåˆ 8 ç‚¹åˆ°ä¸‹åˆ 18 ç‚¹ï¼Œæ¯ 2 å°æ—¶åçš„æ¯ 5 åˆ†é’Ÿè¿è¡Œä¸€æ¬¡ä»»åŠ¡')
})
```

## å®šæ—¶ä»»åŠ¡æ–¹æ³•

è®©æˆ‘ä»¬å…³æ³¨ä¸€ä¸‹ä¸‰ä¸ªå…³é”®çš„å®šæ—¶ä»»åŠ¡æ–¹æ³•ã€‚

### å¼€å§‹ä»»åŠ¡

å°† `scheduled` é€‰é¡¹å€¼è®¾ç½®ä¸º `false` æ—¶ï¼Œä»»åŠ¡å°†è¢«è°ƒåº¦ï¼Œä½†æ— æ³•å¯åŠ¨ï¼Œå³ä½¿ cron è¡¨è¾¾å¼æ­£åœ¨æ»´ç­”ä½œå“ã€‚

è¦å¯åŠ¨è¿™æ ·çš„ä»»åŠ¡ï¼Œæ‚¨éœ€è¦è°ƒç”¨ `start` æ–¹æ³•ã€‚

```js
const cron = require('node-cron')

const task = cron.schedule('*/5 8-18/2 * * *', () => {
  console.log('ä»ä¸Šåˆ 8 ç‚¹åˆ°ä¸‹åˆ 18 ç‚¹ï¼Œæ¯ 2 å°æ—¶åçš„æ¯ 5 åˆ†é’Ÿè¿è¡Œä¸€æ¬¡ä»»åŠ¡')
})

task.start()
```

### åœæ­¢ä»»åŠ¡

å¦‚æœéœ€è¦åœæ­¢ä»»åŠ¡è¿è¡Œï¼Œå¯ä»¥ä½¿ç”¨ `stop` æ–¹æ³•å°† `scheduled` é€‰é¡¹è®¾ç½®ä¸º `false`ã€‚é™¤éé‡æ–°å¯åŠ¨ï¼Œå¦åˆ™ä¸ä¼šæ‰§è¡Œè¯¥ä»»åŠ¡ã€‚

```js
const cron = require('node-cron')

const task = cron.schedule('*/5 8-18/2 * * *', () => {
  console.log('ä»ä¸Šåˆ 8 ç‚¹åˆ°ä¸‹åˆ 18 ç‚¹ï¼Œæ¯ 2 å°æ—¶åçš„æ¯ 5 åˆ†é’Ÿè¿è¡Œä¸€æ¬¡ä»»åŠ¡')
})

task.stop()
```

### é”€æ¯ä»»åŠ¡

`destroy` æ–¹æ³•åœæ­¢ä»»åŠ¡å¹¶å°†å…¶å®Œå…¨é”€æ¯ã€‚

```js
const cron = require('node-cron')

const task = cron.schedule('*/5 8-18/2 * * *', () => {
  console.log('ä»ä¸Šåˆ 8 ç‚¹åˆ°ä¸‹åˆ 18 ç‚¹ï¼Œæ¯ 2 å°æ—¶åçš„æ¯ 5 åˆ†é’Ÿè¿è¡Œä¸€æ¬¡ä»»åŠ¡')
})

task.destroy()
```

ä»¥ä¸Šä¾¿æ˜¯ `node-cron` çš„å¤§éƒ¨åˆ†åŠŸèƒ½ï¼Œæ‚¨åº”è¯¥ä½¿ç”¨è¿™äº›åŠŸèƒ½æ¥å®‰æ’é¢‘ç¹è¿è¡Œçš„ä»»åŠ¡ã€‚

## ç¤ºä¾‹ï¼šåˆ é™¤é”™è¯¯æ—¥å¿—æ–‡ä»¶

è€ƒè™‘ä¸€ä¸ªåœºæ™¯ï¼Œæ‚¨éœ€è¦åœ¨æ¯ä¸ªæœˆçš„ç¬¬åäº”å¤©å®šæœŸä»æœåŠ¡å™¨ä¸­åˆ é™¤æ—¥å¿—æ–‡ä»¶ã€‚

```js
const cron = require('node-cron')
const fs = require('fs')

cron.schedule('0 0 15 * *', () => {
  fs.unlink('./error.log', (err) => {
    if (err) throw err
    console.log('é”™è¯¯æ—¥å¿—æ–‡ä»¶å·²æˆåŠŸåˆ é™¤')
  })
})
```

## ç¤ºä¾‹ï¼šå¤‡ä»½æ•°æ®åº“

ç¡®ä¿ç”¨æˆ·æ•°æ®çš„ä¿å­˜æ˜¯ä»»ä½•ä¸šåŠ¡çš„å…³é”®ã€‚å¦‚æœå‘ç”Ÿæ„å¤–äº‹ä»¶ï¼Œå¹¶ä¸”æ•°æ®åº“æŸåï¼Œåˆ™éœ€è¦ä»å¤‡ä»½ä¸­æ¢å¤æ•°æ®åº“ã€‚å¦‚æœæ‚¨çš„ä¸šåŠ¡æ²¡æœ‰ä»»ä½•å½¢å¼çš„ç°æœ‰å¤‡ä»½ï¼Œæ‚¨å°†é¢ä¸´ä¸¥é‡çš„éº»çƒ¦ã€‚

è€ƒè™‘ä¸€ä¸ªåœºæ™¯ï¼Œæ‚¨éœ€è¦åœ¨æ¯å¤©æ™šä¸Š 11:59 ä¾‹è¡Œå¤‡ä»½æ•°æ®åº“è½¬å‚¨ã€‚

å‡è®¾æ‚¨å·²ç»åœ¨ç¯å¢ƒä¸­å®‰è£…å¹¶è¿è¡Œäº† SQLiteã€‚ç»™å®šä¸€ä¸ªåä¸º `database.sqlite` çš„æ•°æ®åº“ï¼Œç”¨äºè¿›è¡Œæ•°æ®åº“å¤‡ä»½çš„ shell å‘½ä»¤å¯èƒ½ç±»ä¼¼äºï¼š

```bash
sqlite3 database.sqlite .dump > data_dump.sql
```

ä¸ºäº†æ‰§è¡Œä»¥ä¸Šå‘½ä»¤ï¼Œæˆ‘ä»¬å®‰è£… `shelljs`ï¼š

```bash
pnpm install shelljs
```

å®ƒå¯ä»¥åœ¨è¿è¡Œ shell å‘½ä»¤ã€‚

å®Œæ•´ç¤ºä¾‹å¦‚ä¸‹ï¼š

```js
const cron = require('node-cron')
const shell = require('shelljs')

// æ¯å¤©æ™šä¸Š 11:59 å¤‡ä»½æ•°æ®åº“
cron.schedule('59 23 * * *', () => {
  if (shell.exec('sqlite3 database.sqlite .dump > data_dump.sql').code !== 0) {
    shell.exit(1)
  } else {
    shell.echo('æ•°æ®åº“å¤‡ä»½å®Œæˆ')
  }
})
```

## ç¤ºä¾‹ï¼šå‘é€é¢„å®šçš„ç”µå­é‚®ä»¶

å‘é€ç”µå­é‚®ä»¶ï¼Œnodemailer åŒ…å¯ä»¥å¸®åŠ©åˆ°æˆ‘ä»¬ï¼Œå®‰è£…ï¼š

```bash
pnpm i nodemailer
```

å‡è®¾æˆ‘ä»¬éœ€è¦åœ¨æ¯å‘¨äº”ä¸ºå…¬å¸å‘˜å·¥ç»Ÿä¸€å‘é€ä¸€å°é‚®ä»¶ï¼š

```js
const cron = require('node-cron')
const nodemailer = require('nodemailer')

// åˆ›å»ºé‚®ä»¶ä¼ è¾“å™¨
let transporter = nodemailer.createTransport({
  host: 'your_demo_email_smtp_host.example.com',
  port: your_demo_email_port,
  auth: {
    user: 'your_demo_email_address@example.com',
    pass: 'your_demo_email_password'
  }
})

// æ¯å‘¨äº”å‘é€é‚®ä»¶
cron.schedule('0 0 * * 5', () => {
  let messageOptions = {
    from: 'your_demo_email_address@example.com',
    to: 'your_demo_email_address@example.com',
    subject: 'é¢„å®šç”µå­é‚®ä»¶',
    text: 'ä½ å¥½ï¼Œè¿™å°ç”µå­é‚®ä»¶æ˜¯å…¬å¸è‡ªåŠ¨å‘é€çš„ã€‚'
  }

  transporter.sendMail(messageOptions, (error, info) => {
    if (error) {
      throw error
    } else {
      console.log('ç”µå­é‚®ä»¶å·²æˆåŠŸå‘é€ï¼')
    }
  })
})
```

å¦‚æœéœ€è¦æµ‹è¯•æ•ˆæœï¼ŒNodemailer æ”¯æŒ [Ethereal Email](https://ethereal.email/) æä¾›çš„æµ‹è¯•è´¦æˆ·ã€‚åˆ›å»ºä¸€ä¸ª Ethereal å¸æˆ·å¹¶ä½¿ç”¨ä¸ºæ‚¨ç”Ÿæˆçš„ç”¨æˆ·åå’Œå¯†ç ã€‚

## æ›´å¤šèµ„æ–™

[How To Easily And Safely Manage Cron Jobs In Linux](https://ostechnix.com/how-to-easily-and-safely-manage-cron-jobs-in-linux/)
