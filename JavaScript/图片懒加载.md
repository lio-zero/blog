# å›¾ç‰‡æ‡’åŠ è½½

æ‡’åŠ è½½ï¼Œé€šå¸¸æ˜¯å»¶è¿ŸåŠ è½½åˆå§‹è§†å£å¤–çš„å›¾åƒï¼Œç›´åˆ°æˆ‘ä»¬æ»šåŠ¨é¡µé¢ï¼Œè¾¾åˆ°å›¾åƒä¸åº•éƒ¨è§†å£çš„äº¤æ±‡å¤„æ‰å¼€å§‹åŠ è½½å›¾åƒã€‚

æˆ‘ä»¬éœ€è¦åšçš„æ˜¯**åˆ¤æ–­å›¾ç‰‡æ˜¯å¦å‡ºç°åœ¨å½“å‰è§†å£ï¼Œç„¶åæ§åˆ¶å›¾ç‰‡çš„åŠ è½½**ã€‚

æœ‰å‡ ç§å®ç°æ–¹å¼ï¼š

- `scroll` å’Œä½ç½®è®¡ç®—
- `getBoundingClientRect API`
- `IntersectionObserver API`
- `loading` å±æ€§
- ç¬¬ä¸‰æ–¹åº“ï¼ˆæ— éæ˜¯ä¸Šè¿°æ–¹æ³•çš„å®ç°ï¼‰

## scroll å’Œä½ç½®è®¡ç®—

æˆ‘ä»¬éœ€è¦ä½¿ç”¨ `clientTop`ã€`offsetTop`ã€`clientHeight` å’Œ `scrollTop` è®¡ç®—å›¾ç‰‡ä½ç½®ã€‚

> å…³äºè¿™äº›å±æ€§çš„ç›¸å…³å†…å®¹è¯·æŸ¥çœ‹[å…ƒç´ å¤§å°å’Œæ»šåŠ¨](https://zh.javascript.info/size-and-scroll#offsetwidthheight)ã€‚

å¤§è‡´çš„ä»£ç å¦‚ä¸‹ï¼š

```js
let imgs = document.querySelectorAll('img')

function lazyload() {
  const clientH = document.documentElement.clientHeight
  const clientT = document.documentElement.scrollTop || document.body.scrollTop
  for (let i = 0; i < imgs.length; i++) {
    if (clientH + clientT > imgs[i].offsetTop && !imgs[i].src) {
      imgs[i].src = imgs[i].getAttribute('data-src')
    }
  }
}
```

é€šè¿‡ç›‘å¬ `window.scroll` æ»šåŠ¨äº‹ä»¶ï¼Œæ»šåŠ¨æ—¶è®¡ç®—å›¾ç‰‡ä¸è§†å£çš„ä½ç½®ï¼Œä¸ºå›¾ç‰‡çš„ `src` èµ‹å€¼å³å¯ã€‚

```js
doucment.addEventListener('scroll', () => {
  // ...
})
```

éœ€è¦è€ƒè™‘ ğŸ¤” çš„é—®é¢˜ï¼Œæˆ‘ä»¬æ¯æ»šåŠ¨ä¸€æ¬¡é¡µé¢éƒ½ä¼šè§¦å‘å¤šæ¬¡ `scroll` æ»šåŠ¨äº‹ä»¶åŠå…¶äº‹ä»¶å¤„ç†ç¨‹åºã€‚ä¸ºäº†æ€§èƒ½è€ƒè™‘ï¼Œæˆ‘ä»¬ä¸ºå…¶åŠ ä¸€ä¸ªèŠ‚æµå™¨ï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ Lodash åº“çš„ [`_.throttle()`](https://lodash.com/docs/4.17.15#throttle) æ–¹ä¾¿å¿«é€Ÿå¼€å‘ã€‚

```js
_.throttle(func, [(wait = 0)], [(options = {})])
```

## getBoundingClientRect API

ä¸ºäº†ä¸é‚£ä¹ˆéº»çƒ¦çš„è®¡ç®—å…ƒç´ çš„ä½ç½®ï¼Œæµè§ˆå™¨ä¸ºæˆ‘ä»¬æä¾›äº†æ–°çš„ `getBoundingClientRect API`ã€‚

> [`Element.getBoundingClientRect()`](https://developer.mozilla.org/zh-CN/docs/Web/API/Element/getBoundingClientRect) æ–¹æ³•è¿”å›å…ƒç´ çš„å¤§å°åŠå…¶ç›¸å¯¹äºè§†å£çš„ä½ç½®ã€‚

ğŸ‘‡ ä¸‹å›¾æ¥è‡ª MDNï¼š

![DOMRect ç¤ºä¾‹å›¾](https://upload-images.jianshu.io/upload_images/18281896-e3ba93318f2551a9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

é€šè¿‡ `Element.getBoundingClientRect()` è·å–å…ƒç´ ç›¸å¯¹äºæµè§ˆå™¨çš„ `top` å€¼ï¼Œä¸å½“å‰å¯è§†åŒºé«˜åº¦è¿›è¡Œå¯¹æ¯”ï¼ˆé€šè¿‡ `document.body.clientHeight` è·å–ï¼‰ï¼Œå¦‚æœå°äºå¯è§†åŒºé«˜åº¦ï¼Œè¯´æ˜å›¾ç‰‡è¿›å…¥å¯è§†èŒƒå›´ï¼Œå¯ä»¥åŠ è½½å›¾åƒäº†ã€‚

```js
const viewHeight = document.body.clientHeight
const rect = item.getBoundingClientRect()

if (rect.bottom >= 0 && rect.top < viewHeight) { ... }
```

## IntersectionObserver API

> [Intersection Observer API](https://developer.mozilla.org/zh-CN/docs/Web/API/Intersection_Observer_API) æä¾›äº†ä¸€ç§å¼‚æ­¥æ£€æµ‹ç›®æ ‡å…ƒç´ ä¸ç¥–å…ˆå…ƒç´ æˆ– [viewport](https://developer.mozilla.org/zh-CN/docs/Glossary/Viewport) ç›¸äº¤æƒ…å†µå˜åŒ–çš„æ–¹æ³•ã€‚

åˆ›å»ºä¸€ä¸ª `observer` åéœ€è¦ç»™å®šä¸€ä¸ªç›®æ ‡å…ƒç´ è¿›è¡Œè§‚å¯Ÿã€‚

```js
const target = document.querySelector('.list')

observer.observe(target)
```

åªè¦ç›®æ ‡æ»¡è¶³ä¸º IntersectionObserver æŒ‡å®šçš„é˜ˆå€¼ï¼Œå°±ä¼šè°ƒç”¨å›è°ƒã€‚å›è°ƒæ¥æ”¶ [`IntersectionObserverEntry`](https://developer.mozilla.org/zh-CN/docs/Web/API/IntersectionObserverEntry) å¯¹è±¡å’Œè§‚å¯Ÿè€…çš„åˆ—è¡¨ï¼š

```js
const callback = (entries, observer) => {
  entries.forEach((entry) => {
    // æ¯ä¸ªæ¡ç›®æè¿°äº†ä¸€ä¸ªè§‚å¯Ÿåˆ°çš„ç›®æ ‡å…ƒç´ çš„äº¤ç‚¹å˜åŒ–ï¼š
    // entry.boundingClientRect
    // entry.intersectionRatio
    // entry.intersectionRect
    // entry.isIntersecting
    // entry.rootBounds
    // entry.target
    // entry.time
  })
}
```

å…¶ä¸­ï¼Œ`entry.isIntersecting` ä»£è¡¨ç›®æ ‡å…ƒç´ å¯è§ï¼š

```js
const observer = new IntersectionObserver((target) => {
  // target ä¸ºç›®æ ‡å…ƒç´ é›†åˆ
  target.forEach((entry) => {
    if (entry.isIntersecting) {
      const img = entry.target
      img.src = img.dataset.src
      observer.unobserve(img) // è§£é™¤è§‚å¯Ÿ
    }
  })
})

observer.observe(img)
```

## loading å±æ€§

åªéœ€è¦ä¸º `img` åŠ ä¸Š `loading=lazy`ï¼š

```html
<img src="/path/to/pic.jpg" loading="lazy" />
```

ä½¿ç”¨æ—¶ï¼Œè€ƒè™‘å…¼å®¹æƒ…å†µã€‚

è¯¦ç»†å†…å®¹æŸ¥çœ‹ï¼š

- [ä½¿ç”¨ loading å±æ€§å»¶è¿ŸåŠ è½½å›¾ç‰‡](https://github.com/lio-zero/blog/blob/main/HTML/%E4%BD%BF%E7%94%A8%20loading%20%E5%B1%9E%E6%80%A7%E5%BB%B6%E8%BF%9F%E5%8A%A0%E8%BD%BD%E5%9B%BE%E7%89%87.md)
- [Native image lazy-loading for the web!](https://addyosmani.com/blog/lazy-loading/)

## ç¬¬ä¸‰æ–¹åº“

ä¸€äº›ç¬¬ä¸‰æ–¹åº“çš„é€‰æ‹©ï¼š

- [vanilla-lazyload](https://github.com/verlok/vanilla-lazyload)
- [lazysizes](https://github.com/aFarkas/lazysizes)
- [layzr.js](https://github.com/callmecavs/layzr.js)
- [lozad.js](https://github.com/ApoorvSaxena/lozad.js) é™„å¸¦ [Lozad.js: Performant Lazy Loading of Images](https://css-tricks.com/lozad-js-performant-lazy-loading-images/)
- Vue å¯ä»¥ä½¿ç”¨ [vue-lazyload](https://github.com/hilongjw/vue-lazyload)
- React å¯ä»¥ä½¿ç”¨ [react-lazyload](https://www.npmjs.com/package/react-lazyload)ã€[react-intersection-observer](https://www.npmjs.com/package/react-intersection-observer) æˆ– [react-lazy-load-image-component](https://www.npmjs.com/package/react-lazy-load-image-component)
