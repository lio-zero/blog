# ES2020ï¼ˆES11ï¼‰

æ–°ç‰¹æ€§ï¼š

- `String.prototype.matchAll`
- `import()`
- `import.meta`
- `BigInt` â€” ä»»æ„ç²¾åº¦æ•´æ•°
- `Promise.allSettled`
- `globalThis`
- `for-in`
- å¯é€‰é“¾ â€” `?.`
- ç©ºå€¼åˆå¹¶è¿ç®—ç¬¦ â€” `??`
- `export * as ns from "mod"`

## String.prototype.matchAll()

`matchAll()` è¿”å›å…¨å±€æ­£åˆ™è¡¨è¾¾å¼çš„æ‰€æœ‰åŒ¹é…é¡¹ã€‚

ç»™å®šä¸€ä¸ªå­—ç¬¦ä¸²æˆ–ä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼ï¼Œ`matchAll()` åœ¨æ‰€æœ‰åŒ¹é…é¡¹çš„åŒ¹é…å¯¹è±¡ä¸Šè¿”å›ä¸€ä¸ªå¯è¿­ä»£å¯¹è±¡ã€‚

```js
let regexp = /t(e)(st(\d?))/
let str = 'test1test2'

// ä½¿ç”¨æ‰©å±•è¿ç®—ç¬¦ `(...)` å°†å¯è¿­ä»£å¯¹è±¡è½¬æ¢ä¸ºæ•°ç»„ï¼š
let array = [...str.matchAll(regexp)]

array[0] // ["test1", "e", "st1", "1"]
array[1] // ["test2", "e", "st2", "2"]
```

> **æ³¨æ„**ï¼šå¿…é¡»è®¾ç½® `g` ä¿®é¥°ç¬¦

### `RegExp.prototype.exec()` ä¸ `/g`

åœ¨ä»¥ä¸‹ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬æ”¶é›†æ•°ç»„åŒ¹é…ä¸­ç»„ 1 çš„æ‰€æœ‰æ•è·ï¼š

```js
function collectGroup1(regExp, str) {
  const matches = []
  while (true) {
    const match = regExp.exec(str)
    if (match === null) break
    // å°†ç»„ 1 çš„æ•è·æ·»åŠ åˆ° matches
    matches.push(match[1])
  }
  return matches
}

collectGroup1(/"([^"]*)"/gu, `"foo" and "bar" and "baz"`) // [ 'foo', 'bar', 'baz' ]
```

æ²¡æœ‰æ ‡å¿— `/g`ï¼Œ`exec()` å§‹ç»ˆåªè¿”å›ç¬¬ä¸€ä¸ªåŒ¹é…é¡¹ï¼š

```js
const re = /[abc]/
re.exec('abc') // [ 'a', index: 0, input: 'abc' ]

re.exec('abc') // [ 'a', index: 0, input: 'abc' ]
```

è¿™å¯¹ `collectGroup1()` æ¥è¯´æ˜¯ä¸ªåæ¶ˆæ¯ï¼Œå› ä¸ºå¦‚æœ `regExp` æ²¡æœ‰æ ‡å¿— `/g`ï¼Œå®ƒå°†æ°¸è¿œä¸ä¼šå®Œæˆã€‚

### `String.prototype.match()` ä¸ `/g`

å¦‚æœä½ ä½¿ç”¨ `match()`ï¼Œä½¿ç”¨è®¾ç½®äº†æ ‡å¿— `/g` çš„æ­£åˆ™è¡¨è¾¾å¼ï¼Œå¯ä»¥åœ¨ä¸€ä¸ªæ•°ç»„ä¸­è·å¾—å®ƒçš„æ‰€æœ‰å®Œæ•´åŒ¹é…é¡¹ï¼ˆæ¢å¥è¯è¯´ï¼Œæ•è·ç»„è¢«å¿½ç•¥ï¼‰ï¼š

```js
'abab'.match(/a/gu) // [ 'a', 'a' ]
```

å¦‚æœæœªè®¾ç½® `/g`ï¼Œ`match()` çš„å·¥ä½œåŸç†ä¸ `RegExp.prototype.exec()` ç±»ä¼¼ï¼š

```js
'abab'.match(/a/u) // [ 'a', index: 0, input: 'abab' ]
```

### `String.prototype.replace()` ä¸ `/g`

ä½ å¯ä»¥ä½¿ç”¨ä¸€ä¸ªæŠ€å·§é€šè¿‡æ”¶é›†æ•è· `replace()`ï¼šæˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªå‡½æ•°æ¥è®¡ç®—æ›¿æ¢å€¼ã€‚è¯¥å‡½æ•°æ¥æ”¶æ‰€æœ‰æ•è·ä¿¡æ¯ã€‚ä½†æ˜¯ï¼Œå®ƒä¸è®¡ç®—æ›¿æ¢å€¼ï¼Œè€Œæ˜¯åœ¨æ•°ç»„åŒ¹é…ä¸­æ”¶é›†æ„Ÿå…´è¶£çš„æ•°æ®ï¼š

```js
function collectGroup1(regExp, str) {
  const matches = []
  function replacementFunc(all, first) {
    matches.push(first)
  }
  str.replace(regExp, replacementFunc)
  return matches
}

collectGroup1(/"([^"]*)"/gu, `"foo" and "bar" and "baz"`) // [ 'foo', 'bar', 'baz' ]
```

å¯¹äºä¸å¸¦æ ‡å¿— `/g` çš„æ­£åˆ™è¡¨è¾¾å¼ï¼Œ`replace()` åªè®¿é—®ç¬¬ä¸€ä¸ªåŒ¹é…é¡¹ã€‚

### `RegExp.prototype.test()`

`test()` åªè¦æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…ï¼Œå°±è¿”å› `true`ï¼š

```js
const regExp = /a/gu
const str = 'aa'

regExp.test(str) // true
regExp.test(str) // true
regExp.test(str) // false
```

### `String.prototype.split()`

`split()` å¯ä»¥æ‹†åˆ†å­—ç¬¦ä¸²å¹¶ä½¿ç”¨å­—ç¬¦ä¸²æˆ–æ­£åˆ™è¡¨è¾¾å¼æŒ‡å®šåˆ†éš”ç¬¦ã€‚å¦‚æœè¯¥æ­£åˆ™è¡¨è¾¾å¼è‡³å°‘åŒ…å«ä¸€ä¸ªæ•è·ç»„ï¼Œåˆ™ `split()` è¿”å›ä¸€ä¸ªæ•°ç»„ï¼Œå…¶ä¸­å­å­—ç¬¦ä¸²ä¸ç¬¬ä¸€ä¸ªç»„æ•è·çš„å†…å®¹äº¤é”™ï¼š

```js
const regExp = /<(-+)>/gu
const str = 'a<--->b<->c'

str.split(regExp) // [ 'a', '---', 'b', '-', 'c' ]
```

## åŠ¨æ€å¯¼å…¥ `import()`

åœ¨æ­¤ä¹‹å‰ï¼Œæˆ‘ä»¬åªèƒ½ä½¿ç”¨é™æ€å¯¼å…¥ï¼Œå®ƒåªæ¥å—æ¨¡å—è·¯å¾„çš„å­—ç¬¦ä¸²ã€‚ä½¿ç”¨åŠ¨æ€å¯¼å…¥ï¼Œæˆ‘ä»¬å¿…é¡»ä½¿ç”¨ Promise æœ‰æ¡ä»¶åœ°å¯¼å…¥æ¨¡å—ã€‚

```html
<nav>
  <a href="books.html" data-entry-module="books">Books</a>
  <a href="movies.html" data-entry-module="movies">Movies</a>
  <a href="video-games.html" data-entry-module="video-games">Video Games</a>
</nav>

<main>Content will load here!</main>
```

```js
const main = document.querySelector('main')
for (const link of document.querySelectorAll('nav > a')) {
  link.addEventListener('click', (e) => {
    e.preventDefault()

    import(`./section-modules/${link.dataset.entryModule}.js`)
      .then((module) => {
        module.loadPageInto(main)
      })
      .catch((err) => {
        main.textContent = err.message
      })
  })
}
```

> ç‚¹å‡»æ­¤å¤„ ğŸ‘‰ [Loading modules dynamically via import()](https://exploringjs.com/impatient-js/ch_modules.html#dynamic-imports) äº†è§£æ›´å¤šå†…å®¹ã€‚

## `import.meta`

ç”¨äºä¿å­˜æœ‰å…³å½“å‰æ¨¡å—çš„ç‰¹å®šäºä¸»æœºçš„å…ƒæ•°æ®çš„[å…ƒå±æ€§](https://tc39.es/proposal-import-meta/)ã€‚

```js
;(async () => {
  const response = await fetch(new URL('../hamsters.jpg', import.meta.url))
  const blob = await response.blob()

  const size = import.meta.scriptElement.dataset.size || 300

  const image = new Image()
  image.src = URL.createObjectURL(blob)
  image.width = image.height = size

  document.body.appendChild(image)
})()
```

> ç‚¹å‡»æ­¤å¤„ ğŸ‘‰ [import.meta â€“ metadata for the current module](https://exploringjs.com/impatient-js/ch_modules.html#import.meta) äº†è§£æ›´å¤šå†…å®¹ã€‚

## `BigInt` â€” ä»»æ„ç²¾åº¦æ•´æ•°

`BigInt` ä¸€ç§ç”¨äºå¤§æ•´æ•°è¿ç®—çš„æ–°åŸå§‹æ•°æ®ç±»å‹ï¼Œè¡¨ç¤ºå¤§äº 2âµÂ³ çš„æ•°å­—ã€‚

`BigInt` ä½¿ç”¨ä¸€ç³»åˆ—æ•°å­—ï¼Œåç¼€ä¸º `n`ã€‚

```js
const theBiggestInt = 9886881870000166n

const alsoHuge = BigInt(9886881870000166) // 9007199254740991n

const hugeButString = BigInt('9886881870000166') // 9886881870000166n
```

`typeof` çš„è¿”å›å€¼ä¸º `bigint`ï¼š

```js
typeof 123n // 'bigint'
```

## `Promise.allSettled()`

å½“æ‰€æœ‰ç»™å®šçš„ Promise éƒ½å¾—åˆ°è§£å†³æ—¶è¿”å›ï¼ˆ`resolved` æˆ– `rejected`ï¼Œæ— å…³ç´§è¦ï¼‰ã€‚

```js
const sleep = (sm) =>
  new Promise((resolve) => setTimeout(() => resolve(sm), sm))
const err = (ms) => sleep(ms).then(() => Promise.reject(ms))

Promise.allSettled([1, 2, 3]).then(console.log)
Promise.allSettled([sleep(300), sleep(100), sleep(200)]).then(console.log)
Promise.allSettled([sleep(3000), err(100), sleep(2000)]).then(console.log)
Promise.allSettled([err(50), err(60)]).then(console.log)
```

## `globalThis`

åœ¨æ­¤ä¹‹å‰ï¼Œå…¨å±€å¯¹è±¡ç”±äºä¸åŒçš„ JavaScript ç¯å¢ƒæœ‰ä¸åŒçš„è¯­æ³•ï¼š

- åœ¨ Web æµè§ˆå™¨å¯ä»¥æ˜¯ `window`ï¼Œ`self`ï¼Œ`frames` æˆ– `this`ã€‚
- å¯¹äº Web Worker æ¥è¯´ï¼Œå®ƒæ˜¯ `self`ã€‚
- åœ¨ Node.js ä¸­ï¼Œå®ƒæ˜¯ `global`ã€‚

[`globalThis`](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/globalThis) ä¸ºæ‰€æœ‰ JavaScript ç¯å¢ƒä¸­çš„å…¨å±€å¯¹è±¡æä¾›äº†å•ä¸€è¯­æ³•ã€‚

```js
// node ç¯å¢ƒ
console.log(globalThis)

/**
<ref *1> Object [global] {
  global: [Circular *1],
  clearInterval: [Function: clearInterval],
  clearTimeout: [Function: clearTimeout],
  setInterval: [Function: setInterval],
  setTimeout: [Function: setTimeout] {
    [Symbol(nodejs.util.promisify.custom)]: [Function (anonymous)]
  },
  queueMicrotask: [Function: queueMicrotask],
  clearImmediate: [Function: clearImmediate],
  setImmediate: [Function: setImmediate] {
    [Symbol(nodejs.util.promisify.custom)]: [Function (anonymous)]
  }
}
*/

// æµè§ˆå™¨
globalThis // Window {0: global, 1: global, window: Window, self: Window, ...}
```

> **æ³¨æ„**ï¼š`globalThis` å¹¶ä¸æ€»æ˜¯ç›´æ¥æŒ‡å‘å…¨å±€å¯¹è±¡ã€‚è¯¦ç»†å¯æŸ¥é˜… [In browsers, globalThis does not point directly to the global object](https://exploringjs.com/deep-js/ch_global-scope.html#window-proxy)ã€‚

ä½† `globalThis` ä¼šå¯¹æ€§èƒ½äº§ç”Ÿè´Ÿé¢å½±å“ï¼Œä¹Ÿå¯èƒ½ä¼šäº§ç”Ÿä¸€äº›ä¸åˆ°çš„é”™è¯¯ï¼Œå»ºè®®ä½¿ç”¨ ES6 çš„ä¸€äº›ç‰¹æ€§é¿å…å…¨å±€å¯¹è±¡ï¼Œä¾‹å¦‚ï¼š

- å£°æ˜åœ¨ `const`ã€`let` å’Œ `class` å…¨å±€ä½œç”¨åŸŸå†…ï¼Œä½¿ç”¨æ—¶ä¸ä¼šåˆ›å»ºå…¨å±€å¯¹è±¡å±æ€§ã€‚
- æ¯ä¸ª ES æ¨¡å—éƒ½æœ‰è‡ªå·±çš„å±€éƒ¨ä½œç”¨åŸŸã€‚ï¼ˆé»˜è®¤å¼€å¯ä¸¥æ ¼æ¨¡å¼ï¼‰

## å¯é€‰é“¾ â€” `?.`

å¯é€‰é“¾ `?.` æ˜¯ä¸€ç§è®¿é—®åµŒå¥—å¯¹è±¡å±æ€§çš„å®‰å…¨çš„æ–¹å¼ã€‚å³ä½¿ä¸­é—´çš„å±æ€§ä¸å­˜åœ¨ï¼Œä¹Ÿä¸ä¼šå‡ºç°é”™è¯¯ã€‚

å¦‚æœé—®å·å‰é¢çš„å€¼ä¸æ˜¯ `undefined` ä¹Ÿä¸æ˜¯ `null`ï¼Œåˆ™æ‰§è¡Œé—®å·åé¢çš„æ“ä½œã€‚å¦åˆ™ï¼Œè¿”å› `undefined`ã€‚å®ƒæœ‰å¦‚ä¸‹ä¸‰ç§è¯­æ³•ï¼š

```js
obj?.prop // å¯é€‰çš„é™æ€å±æ€§è®¿é—®
obj?.[prop] // å¯é€‰çš„åŠ¨æ€å±æ€§è®¿é—®
func?.(...args) // å¯é€‰æ–¹æ³•è°ƒç”¨
```

- `obj?.prop` â€” å¦‚æœ `obj` å­˜åœ¨åˆ™è¿”å› `obj.prop`ï¼Œå¦åˆ™è¿”å› `undefined`ã€‚
- `obj?.[prop]` â€” å¦‚æœ `obj` å­˜åœ¨åˆ™è¿”å› `obj[prop]`ï¼Œå¦åˆ™è¿”å› `undefined`ã€‚
- `obj.method?.(...args)` â€” å¦‚æœ `obj.method` å­˜åœ¨åˆ™è°ƒç”¨ `obj.method()`ï¼Œå¦åˆ™è¿”å› `undefined`ã€‚

```js
const user = {}

user.address.street // TypeError
user?.address?.street // undefined
```

### å¯é€‰é“¾çš„æ›¿ä»£æ–¹æ¡ˆ

#### &&

```js
user && user.address && user.address.street // undefined
```

**ç¼ºç‚¹**ï¼š

- è¯­æ³•å†—é•¿
- å¦‚æœå¤±è´¥ï¼Œ`&&`è¿”å›å…¶å·¦ä¾§ï¼Œè€Œ `?.` å§‹ç»ˆè¿”å› `undefined`ï¼š
- `&&` å¯¹æ‰€æœ‰è™šå€¼çš„å·¦ä¾§éƒ½å¤±è´¥ï¼Œè€Œ `?.` åªå¯¹`undefined` å’Œ `null` å¤±è´¥ï¼š

#### è§£æ„

æ‚¨è¿˜å¯ä»¥ä½¿ç”¨è§£æ„æ¥å¤„ç†é“¾å¼å±æ€§è®¿é—®ï¼Œä½†è¿™å¹¶ä¸ç¾è§‚ï¼š

```js
const { address: { street = undefined } = {} } = user

street // undefined
```

#### ç¬¬ä¸‰æ–¹åº“ï¼šLodash åº“çš„ `get()` æ–¹æ³•

```js
_.get(user, 'address.street')
```

### æ”¯æŒæƒ…å†µ

å¯é€‰é“¾ï¼ˆ`?.`ï¼‰å·²ç»æ”¯æŒå¤§éƒ¨åˆ†çš„ä¸»æµæµè§ˆå™¨ï¼š

![å¯é€‰é“¾](https://upload-images.jianshu.io/upload_images/18281896-6268201ef1e6d507.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

å¦‚æœæ‚¨éœ€è¦æ”¯æŒ IE æˆ–æ›´ä½ç‰ˆæœ¬æµè§ˆå™¨ï¼Œbabel æœ‰ä¸€ä¸ªæ’ä»¶ â€” [`@babel/plugin-proposal-optional-chaining`](https://babeljs.io/docs/en/babel-plugin-proposal-optional-chaining)ã€‚

> ç‚¹å‡»æ­¤å¤„ ğŸ‘‰ [å¯é€‰é“¾ "?."](https://zh.javascript.info/optional-chaining) äº†è§£æ›´å¤šå†…å®¹ã€‚

## ç©ºå€¼åˆå¹¶è¿ç®—ç¬¦ â€” `??`

`??` ä¸ºäºŒå…ƒè¿ç®—ç¬¦ã€‚å¦‚æœå·¦ä¾§è¡¨è¾¾å¼çš„å€¼ä¸º `null` æˆ– `undefined`ï¼Œåˆ™è®¡ç®—è¿ç®—ç¬¦çš„å³ä¾§ã€‚

```js
const data = {
  nullValue: null,
  height: 400,
  animationDuration: 0,
  headerText: '',
  showSplashScreen: false
}

console.log(data.undefinedValue ?? 'some other default') // 'some other default'
console.log(data.nullValue ?? 'some other default') // 'some other default'
console.log(data.headerText ?? 'Hello, world!') // ''
console.log(data.animationDuration ?? 300) // 0
console.log(data.showSplashScreen ?? true) // false
```

å¯ä»¥çœ‹åˆ°ï¼Œå®ƒåªå…³å¿ƒå·¦ä¾§çš„å€¼æ˜¯å¦ä¸º `null` æˆ– `undefined`ï¼Œè€Œä¸åœ¨ä¹æ˜¯å¦ä¸ºè™šå€¼ã€‚

> ç‚¹å‡»æ­¤å¤„ ğŸ‘‰ [ç©ºå€¼åˆå¹¶è¿ç®—ç¬¦ '??'](https://zh.javascript.info/nullish-coalescing-operator) äº†è§£æ›´å¤šå†…å®¹ã€‚

## `export * as ns from 'mod'`

è¯­æ³•ï¼š

```js
export * as ns from 'module'
```

ç¤ºä¾‹ï¼š

```js
export * as ns from './utils'

// ğŸ‘† ç­‰åŒäº ğŸ‘‡

import * as ns from './utils'
export { ns }
```

### æ‰©å±•

[Airbnb è§„èŒƒ](https://github.com/airbnb/javascript)å»ºè®®æˆ‘ä»¬ä¸è¦ä½¿ç”¨é€šé…ç¬¦å¯¼å…¥ã€‚

> **åŸå› **ï¼šç¡®ä¿æ‚¨æœ‰ä¸€ä¸ªé»˜è®¤å¯¼å‡ºã€‚

```js
// bad
import * as AirbnbStyleGuide from './AirbnbStyleGuide'

// good
import AirbnbStyleGuide from './AirbnbStyleGuide'
```

å¹¶ä¸”ä¸è¦ç›´æ¥ä» `import` ä¸­ `export`

> **åŸå› **ï¼šå°½ç®¡å•è¡Œä»£ç å¾ˆç®€æ´ï¼Œä½†æ˜¯ä½¿ç”¨ä¸€ç§æ¸…æ™°çš„å¯¼å…¥æ–¹å¼å’Œä¸€ç§æ¸…æ™°çš„å¯¼å‡ºæ–¹å¼å¯ä»¥ä½¿äº‹æƒ…ä¿æŒä¸€è‡´ã€‚

```js
// bad
// es6.js
export { es6 as default } from './AirbnbStyleGuide'

// good
// es6.js
import { es6 } from './AirbnbStyleGuide'
export default es6
```

> ç‚¹å‡»æ­¤å¤„ ğŸ‘‰[Normative: Add export \* as ns from "modâ€ to Export production and Module Semantic](https://github.com/tc39/ecma262/pull/1174) äº†è§£æ›´å¤šè¯¦æƒ…ã€‚

## æŒ‡å®š `for-in` æšä¸¾é¡ºåº

ä¸åŒçš„å¼•æ“å·²å°±å¦‚ä½•æŒ‡å®š [`for-in`](https://github.com/bakkot/for-in-exploration) æšä¸¾é¡ºåºè¾¾æˆä¸€è‡´ï¼Œä»è€Œä½¿è¡Œä¸ºæ ‡å‡†åŒ–ã€‚

```js
let obj = {
  p1: 'p1',
  p2: 'p2',
  p3: 'p3'
}

let keys = []
for (let key in o) {
  if (key === 'p1') {
    o.p4 = 'p4'
  }
  keys.push(key)
}
```

## æ›´å¤šèµ„æ–™

[ECMAScript 2020: the final feature set](https://2ality.com/2019/12/ecmascript-2020.html)
