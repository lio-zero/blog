# æ„å»ºæ¨¡å—æ‰“åŒ…å™¨

æœ¬æ–‡çš„æ¨¡å—æ‰“åŒ…å™¨æ¥è‡ªç¤ºä¾‹ [Minipack](https://github.com/ronami/minipack)ï¼Œæˆ‘ä»¬å°†æ¥äº†è§£å®ƒæ˜¯å¦‚ä½•ä¸€æ­¥æ­¥å®ç°çš„ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬å…ˆæ¥äº†è§£å®ç°ä¸€ä¸ªæ¨¡å—æ‰“åŒ…å™¨æ‰€éœ€è¦ä¾èµ–çš„ babel æ’ä»¶ï¼š

- [`@babel/traverse`](https://www.npmjs.com/package/@babel/traverse) â€” ç»´æŠ¤æ•´ä¸ªæ ‘çš„çŠ¶æ€ï¼Œè´Ÿè´£æ›¿æ¢ã€åˆ é™¤å’Œæ·»åŠ èŠ‚ç‚¹ã€‚
- [`@babel/core`](https://www.npmjs.com/package/@babel/core) â€” Babel ç¼–è¯‘å™¨æ ¸å¿ƒã€‚
- [`@babel/parser`](https://www.npmjs.com/package/@babel/parser) â€” Babel ä¸­ä½¿ç”¨çš„ JavaScript è§£æå™¨ã€‚
- [`@babel/preset-env`](https://www.npmjs.com/package/@babel/preset-env) â€” æ¯ä¸ªç¯å¢ƒçš„ Babel é¢„è®¾ã€‚å¯æ ¹æ®ç›®æ ‡æµè§ˆå™¨æˆ–è¿è¡Œæ—¶ç¯å¢ƒè‡ªåŠ¨ç¡®å®šæ‰€éœ€çš„ Babel æ’ä»¶å’Œ polyfillsï¼Œä»è€Œå°† ES6+ ç¼–è¯‘è‡³ ES5ã€‚

> æˆ‘ä»¬æ›¿æ¢äº†è¯¥ç¤ºä¾‹çš„æ—§çš„ï¼Œå·²ç»è¢«å¹¶å…¥ babel å†…çš„æ’ä»¶ã€‚

æ„å»ºä¸€ä¸ªç®€å•çš„æ¨¡å—æ‰“åŒ…å™¨åªéœ€è¦ä¸‰ä¸ªæ­¥éª¤ï¼š

- åˆ©ç”¨ babel å®Œæˆä»£ç è½¬æ¢ï¼Œå¹¶ç”Ÿæˆå•ä¸ªæ–‡ä»¶çš„ä¾èµ–
- ç”Ÿæˆä¾èµ–å›¾è°±
- ç”Ÿæˆæœ€åæ‰“åŒ…ä»£ç 

## è½¬æ¢ä»£ç ã€ç”Ÿæˆä¾èµ–

é¦–å…ˆï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ª `createAsset()` å‡½æ•°ï¼Œè¯¥å‡½æ•°å°†æ¥å— `filename` å‚æ•°ï¼ˆæ–‡ä»¶è·¯å¾„ï¼‰ï¼Œè¯»å–å†…å®¹å¹¶æå–å®ƒçš„ä¾èµ–å…³ç³»ã€‚

```js
const fs = require('fs')

function createAsset(filename) {
  const content = fs.readFileSync(filename, 'utf-8')
}
```

æˆ‘ä»¬ä½¿ç”¨ `fs.readFileSync` è¯»å–æ–‡ä»¶ï¼Œå¹¶è¿”å›æ–‡ä»¶å†…å®¹ã€‚

æ ¹æ®å…¶å†…å®¹ï¼Œæˆ‘ä»¬å¯ä»¥è·å–åˆ° `import` å­—ç¬¦ä¸²ï¼ˆä¾èµ–çš„æ–‡ä»¶ï¼‰ã€‚

ä¸‹é¢ï¼Œæˆ‘ä»¬å°†ç”¨åˆ° JavaScript è§£æå™¨ â€” `@babel/parser`ï¼Œå®ƒæ˜¯è¯»å–å’Œç†è§£ JavaScript ä»£ç çš„å·¥å…·ã€‚å®ƒç”Ÿæˆä¸€ä¸ªæ›´æŠ½è±¡çš„æ¨¡å‹ï¼Œç§°ä¸º ASTï¼ˆæŠ½è±¡è¯­æ³•æ ‘ï¼‰ã€‚

AST åŒ…å«å¾ˆå¤šå…³äºæˆ‘ä»¬ä»£ç çš„ä¿¡æ¯ã€‚æˆ‘ä»¬å¯ä»¥æ‰“å°å®ƒäº†è§£æˆ‘ä»¬çš„ä»£ç æ­£åœ¨å°è¯•åšä»€ä¹ˆã€‚

```js
const parser = require('@babel/parser')

function createAsset(filename) {
  // ...
  const ast = parser.parse(content, {
    sourceType: 'module' // è¯†åˆ« ES æ¨¡å—
  })

  console.log(ast)
}
```

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éå† AST æ¥è¯•ç€ç†è§£è¿™ä¸ªæ¨¡å—ä¾èµ–å“ªäº›æ¨¡å—ã€‚

```js
const traverse = require('@babel/traverse').default

function createAsset(filename) {
  // ...
  // å­˜æ”¾æ¨¡å—çš„ç›¸å¯¹è·¯å¾„
  const dependencies = []

  traverse(ast, {
    // è·å–é€šè¿‡ import å¼•å…¥çš„æ¨¡å—
    ImportDeclaration({ node }) {
      // ä¿å­˜æ‰€ä¾èµ–çš„æ¨¡å—
      dependencies.push(node.source.value)
    }
  })
}
```

æˆ‘ä»¬çŸ¥é“ ES æ¨¡å—æ˜¯é™æ€çš„ï¼Œè¿™æ„å‘³ç€ä½ ä¸èƒ½ `import` ä¸€ä¸ªå˜é‡ï¼Œæˆ–è€…æœ‰æ¡ä»¶åœ° `import` å¦ä¸€ä¸ªæ¨¡å—ã€‚æ¯å½“æˆ‘ä»¬çœ‹åˆ° `import` è¯­å¥æ—¶ï¼Œæˆ‘ä»¬å°±å¯ä»¥æŠŠå®ƒçš„å€¼ç®—ä½œä¸€ä¸ªä¾èµ–ã€‚

æˆ‘ä»¬è¿˜é€šè¿‡å¢åŠ ä¸€ä¸ªç®€å•çš„è®¡æ•°å™¨ä¸ºè¿™ä¸ªæ¨¡å—åˆ†é…ä¸€ä¸ªå”¯ä¸€çš„æ ‡è¯†ç¬¦ï¼š

```js
let ID = 0

function createAsset(filename) {
  // ...
  const id = ID++
}
```

æˆ‘ä»¬ä½¿ç”¨ ES æ¨¡å—å’Œå…¶ä»– JavaScript åŠŸèƒ½ï¼Œå¯èƒ½ä¸æ”¯æŒæ‰€æœ‰æµè§ˆå™¨ã€‚

ä¸ºäº†ç¡®ä¿æˆ‘ä»¬çš„ `bundle` åœ¨æ‰€æœ‰æµè§ˆå™¨ä¸­è¿è¡Œï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ [babel](https://babeljs.io) æ ¸å¿ƒåº“ `@babel/core` æ¥ç¼–è¯‘å®ƒã€‚

```js
const { transformFromAst } = require('@babel/core')

function createAsset(filename) {
  // ...
  const { code } = transformFromAst(ast, null, {
    presets: ['@babel/preset-env']
  })

  return {
    id,
    filename,
    dependencies,
    code
  }
}
```

`presets` é€‰é¡¹æ˜¯ä¸€ç»„è§„åˆ™ï¼Œå‘Šè¯‰ `babel` å¦‚ä½•ä¼ è¾“æˆ‘ä»¬çš„ä»£ç ã€‚

å®ƒå†…éƒ¨ä½¿ç”¨ `babel-preset-env` åŒ…å°†æˆ‘ä»¬çš„ä»£ç è½¬æ¢ä¸ºæµè§ˆå™¨å¯ä»¥è¿è¡Œçš„ä¸œè¥¿ã€‚

æœ€åï¼Œæˆ‘ä»¬è¿”å›æœ‰å…³æ­¤æ¨¡å—çš„æ‰€æœ‰ä¿¡æ¯ã€‚

- `id` â€” æ¨¡å—çš„å”¯ä¸€ ID
- `filename` â€” æ¨¡å—çš„ç›¸å¯¹æ–‡ä»¶è·¯å¾„
- `dependencies` â€” å½“å‰æ¨¡å—çš„ä¾èµ–æ¨¡å—ï¼Œå¦‚æœæ²¡æœ‰ï¼Œè¿”å›ç©ºæ•°ç»„ `[]`
- `code` â€” æ¨¡å—ç¼–è¯‘åçš„ä»£ç 

## ç”Ÿæˆä¾èµ–å›¾è°±

ç°åœ¨æˆ‘ä»¬å¯ä»¥æå–å•ä¸ªæ¨¡å—çš„ä¾èµ–å…³ç³»ï¼Œæˆ‘ä»¬å°†ä» `entry` å…¥å£æ–‡ä»¶çš„ä¾èµ–å…³ç³»å¼€å§‹ã€‚

æˆ‘ä»¬å°†æå–å®ƒçš„æ¯ä¸€ä¸ªä¾èµ–å…³ç³»çš„ä¾èµ–å…³ç³»ï¼Œä¾æ¬¡å¾ªç¯ï¼Œç›´åˆ°æˆ‘ä»¬äº†è§£åº”ç”¨ç¨‹åºä¸­çš„æ¯ä¸ªæ¨¡å—ä»¥åŠå®ƒä»¬å¦‚ä½•ç›¸äº’ä¾èµ–ã€‚è¿™ä¸ªé¡¹ç›®çš„ç†è§£è¢«ç§°ä¸ºä¾èµ–å›¾è°±ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬ç¼–å†™ä¸€ä¸ª `createGraph()` å‡½æ•°ï¼Œä¼ å…¥å…¥å£æ–‡ä»¶ï¼Œå¹¶è§£ææ•´ä¸ªæ–‡ä»¶ã€‚

```js
function createGraph(entry) {
  const mainAsset = createAsset(entry)

  const queue = [mainAsset]
}
```

ä¸Šé¢ä»£ç ä¸­ï¼Œæˆ‘ä»¬è¿˜å®šä¹‰ä¸€ä¸ªåªæœ‰å…¥å£èµ„æºçš„ `queue` æ•°ç»„ï¼Œå®ƒç”¨æ¥è§£ææ¯ä¸ªèµ„æºçš„ä¾èµ–å…³ç³»ã€‚

ä½¿ç”¨ä¸€ä¸ª `for ... of` å¾ªç¯éå† `queue`ã€‚

æœ€åˆ `queue` åªæœ‰ä¸€ä¸ªèµ„æºï¼Œä½†æ˜¯å½“æˆ‘ä»¬è¿­ä»£å®ƒæ—¶ï¼Œæˆ‘ä»¬ä¼šå°†é¢å¤–çš„æ–°èµ„æºï¼Œæ¨å…¥ `queue` ä¸­ã€‚

```js
const path = require('path')
function createGraph(entry) {
  // ...

  for (const asset of queue) {
    // å­˜æ”¾ä¾èµ–æ¨¡å—å’Œå¯¹åº”çš„å”¯ä¸€ ID
    asset.mapping = {}
    // æ¨¡å—æ‰€åœ¨çš„ç›®å½•
    const dirname = path.dirname(asset.filename)
    // éå†å…¶ç›¸å…³è·¯å¾„çš„åˆ—è¡¨ï¼Œè·å–å®ƒä»¬çš„ä¾èµ–å…³ç³»
    asset.dependencies.forEach((relativePath) => {
      // createAsset éœ€è¦ä¸€ä¸ªç»å¯¹è·¯å¾„ï¼Œä½†è¯¥ä¾èµ–å…³ç³»ä¿å­˜äº†ä¸€ä¸ªç›¸å¯¹è·¯å¾„çš„æ•°ç»„ï¼Œè¿™äº›è·¯å¾„ç›¸å¯¹äºå®ƒä»¬çš„æ–‡ä»¶
      // æˆ‘ä»¬å¯ä»¥é€šè¿‡å°†ç›¸å¯¹è·¯å¾„ä¸çˆ¶èµ„æºç›®å½•çš„è·¯å¾„è¿æ¥ï¼Œå°†ç›¸å¯¹è·¯å¾„è½¬å˜ä¸ºç»å¯¹è·¯å¾„
      const absolutePath = path.join(dirname, relativePath)
      // è§£æèµ„æºï¼Œè¯»å–å…¶å†…å®¹å¹¶æå–å…¶ä¾èµ–å…³ç³»
      const child = createAsset(absolutePath)
      // äº†è§£ asset ä¾èµ–å–å†³äº child è¿™ä¸€ç‚¹å¯¹æˆ‘ä»¬æ¥è¯´å¾ˆé‡è¦
      // é€šè¿‡ç»™ asset.mapping å¯¹è±¡å¢åŠ ä¸€ä¸ªæ–°çš„å±æ€§ child.id æ¥è¡¨è¾¾è¿™ç§ä¸€ä¸€å¯¹åº”çš„å…³ç³»
      asset.mapping[relativePath] = child.id
      // æœ€åï¼Œæˆ‘ä»¬å°† child è¿™ä¸ªèµ„æºæ¨å…¥ queueï¼Œè¿™æ ·å®ƒçš„ä¾èµ–å…³ç³»ä¹Ÿå°†è¢«è¿­ä»£å’Œè§£æ
      queue.push(child)
    })
  }

  return queue
}
```

åˆ°è¿™ä¸€æ­¥ï¼Œ`queue` å°±æ˜¯ä¸€ä¸ªåŒ…å«ç›®æ ‡åº”ç”¨ä¸­æ¯ä¸ªæ¨¡å—çš„æ•°ç»„ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬çš„ä¾èµ–å…³ç³»å›¾è°±ã€‚

## ç”Ÿæˆ bundle

æœ€åä¸€æ­¥ï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ª `bundle` å‡½æ•°ï¼Œå®ƒå°†ä½¿ç”¨æˆ‘ä»¬çš„ `graph`ï¼Œå¹¶è¿”å›ä¸€ä¸ªå¯ä»¥åœ¨æµè§ˆå™¨ä¸­è¿è¡Œçš„åŒ…ã€‚

```js
function bundle(graph) {
  let modules = ''

  graph.forEach((mod) => {
    modules += `${mod.id}: [
      function (require, module, exports) { ${mod.code} },
      ${JSON.stringify(mod.mapping)},
    ],`
  })
}
```

`graph` ä¸­çš„æ¯ä¸ªæ¨¡å—åœ¨è¿™ä¸ªå¯¹è±¡ä¸­éƒ½æœ‰ä¸€ä¸ª`entry`ï¼ˆä¹Ÿå°±æ˜¯ `filename`ï¼‰ã€‚æˆ‘ä»¬ä½¿ç”¨æ¨¡å—çš„ `id` ä½œä¸º `key` å’Œä¸€ä¸ªæ•°ç»„ä½œä¸º `value`ï¼ˆç”¨æ•°ç»„å› ä¸ºæˆ‘ä»¬åœ¨æ¯ä¸ªæ¨¡å—ä¸­æœ‰ 2 ä¸ªå€¼ï¼‰ã€‚

- ç¬¬ä¸€ä¸ªå€¼æ˜¯ç”¨å‡½æ•°åŒ…è£…çš„æ¯ä¸ªæ¨¡å—çš„ä»£ç ã€‚è¿™æ˜¯å› ä¸ºæ¨¡å—åº”è¯¥è¢«é™å®šèŒƒå›´ï¼šåœ¨ä¸€ä¸ªæ¨¡å—ä¸­å®šä¹‰å˜é‡ä¸ä¼šå½±å“å…¶ä»–æ¨¡å—æˆ–å…¨å±€èŒƒå›´ã€‚æˆ‘ä»¬çš„æ¨¡å—åœ¨æˆ‘ä»¬å°†å®ƒä»¬è¢« babel è½¬è¯‘åï¼Œä½¿ç”¨ CommonJS æ¨¡å—ç³»ç»Ÿï¼šå®ƒä»¬æœŸæœ› `require`ã€`module` å’Œ `exports` å¯¹è±¡å¯ç”¨ã€‚è€Œè¿™äº›æ–¹æ³•åœ¨æµè§ˆå™¨ä¸­é€šå¸¸ä¸å¯ç”¨ï¼Œæ‰€ä»¥æˆ‘ä»¬å°†å®ƒä»¬å®ç°å¹¶å°†å®ƒä»¬æ³¨å…¥åˆ°å‡½æ•°åŒ…è£…ä¸­ã€‚
- å¯¹äºç¬¬äºŒä¸ªå€¼ï¼Œæˆ‘ä»¬ç”¨ `stringify` è§£ææ¨¡å—åŠå…¶ä¾èµ–ä¹‹é—´çš„å…³ç³»ï¼ˆä¹Ÿå°±æ˜¯ä¸Šæ–‡çš„ `asset.mapping`ï¼‰ã€‚è§£æåçš„å¯¹è±¡çœ‹èµ·æ¥åƒè¿™æ ·ï¼š`{'./relative/path': 1}`ã€‚è¿™æ˜¯å› ä¸ºæˆ‘ä»¬çš„æ¨¡å—è¢«è½¬æ¢åä¼šé€šè¿‡ç›¸å¯¹è·¯å¾„æ¥è°ƒç”¨ `require()`ã€‚å½“è°ƒç”¨è¿™ä¸ªå‡½æ•°æ—¶ï¼Œæˆ‘ä»¬åº”è¯¥èƒ½å¤ŸçŸ¥é“ä¾èµ–å›¾è°±ä¸­çš„å“ªä¸ªæ¨¡å—å¯¹åº”äºè¯¥æ¨¡å—çš„ç›¸å¯¹è·¯å¾„ã€‚

> æ¨èï¼šé˜®ä¸€å³°è€å¸ˆçš„[æµè§ˆå™¨åŠ è½½ CommonJS æ¨¡å—çš„åŸç†ä¸å®ç°](https://www.ruanyifeng.com/blog/2015/05/commonjs-in-browser.html)ã€‚

æ¥ç€ï¼Œåˆ›å»ºä¸€ä¸ª IIFE è‡ªæ‰§è¡Œå‡½æ•°ã€‚å…¶ä¸­ï¼Œåˆ›å»ºä¸€ä¸ª `require()` å‡½æ•°ï¼šå®ƒæ¥å—ä¸€ä¸ªæ¨¡å— `ID`ï¼Œå¹¶åœ¨æˆ‘ä»¬ä¹‹å‰æ„å»ºçš„ `modules` å¯¹è±¡æŸ¥æ‰¾å®ƒã€‚

```js
function bundle(graph) {
  // ...
  const result = `
    (function(modules) {
      function require(id) {
        const [fn, mapping] = modules[id];
        function localRequire(name) {
          return require(mapping[name]);
        }
        const module = { exports : {} };
        fn(localRequire, module, module.exports);
        return module.exports;
      }
      require(0);
    })({${modules}})
    `
  // è¿”å›æœ€ç»ˆç»“æœ
  return result
}
```

é€šè¿‡è§£æ„ `const [fn, mapping] = modules[id]` æ¥è·å¾—æˆ‘ä»¬çš„åŒ…è£…å‡½æ•°å’Œ `mappings` å¯¹è±¡ã€‚

æˆ‘ä»¬æ¨¡å—çš„ä»£ç ä½¿ç”¨ç›¸å¯¹æ–‡ä»¶è·¯å¾„è€Œä¸æ˜¯æ¨¡å— ID è°ƒç”¨ `require()`ã€‚ä½†æˆ‘ä»¬çš„ `require` å‡½æ•°æ¥æ”¶æ¨¡å— IDã€‚æ­¤å¤–ï¼Œä¸¤ä¸ªæ¨¡å—å¯èƒ½ `require()` å…·æœ‰ç›¸åŒçš„ç›¸å¯¹è·¯å¾„ï¼Œä½†è¡¨ç¤ºä¸¤ä¸ªä¸åŒçš„æ¨¡å—ã€‚

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå½“éœ€è¦ä¸€ä¸ªæ¨¡å—æ—¶ï¼Œæˆ‘ä»¬ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ä¸“ç”¨ `require` å‡½æ•°ä¾›å…¶ä½¿ç”¨ã€‚å®ƒå°†ç‰¹å®šäºè¯¥æ¨¡å—ï¼Œå¹¶ä¸”å°†çŸ¥é“é€šè¿‡ä½¿ç”¨æ¨¡å—çš„ `mapping` å¯¹è±¡å°†å…¶ç›¸å¯¹è·¯å¾„è½¬æ¢ä¸º IDã€‚`mapping` å¯¹è±¡æ­£æ˜¯è¿™æ ·çš„ï¼Œå³ç‰¹å®šæ¨¡å—çš„ç›¸å¯¹è·¯å¾„å’Œæ¨¡å— ID ä¹‹é—´çš„æ˜ å°„ã€‚

æœ€åï¼Œä½¿ç”¨ CommonJSï¼Œå½“æ¨¡å—éœ€è¦è¢«å¯¼å‡ºæ—¶ï¼Œå®ƒå¯ä»¥é€šè¿‡æ”¹å˜ `exports` å¯¹è±¡æ¥æš´éœ²æ¨¡å—çš„å€¼ã€‚

`require` å‡½æ•°æœ€åä¼šè¿”å› `exports` å¯¹è±¡ã€‚

ä½ å¯ä»¥åˆ›å»ºä¸€ä¸ªæ–‡ä»¶ä¿å­˜æ‰“åŒ…åçš„å†…å®¹ï¼Œåœ¨é¡µé¢ä¸­å¼•å…¥è¿™ä¸ªåŒ…å³å¯ã€‚

```js
const graph = createGraph('./example/entry.js')
const result = bundle(graph)

fs.writeFile('./dist/main.js', result, (err) => {
  if (err) throw err
  process.stdout.write('åˆ›å»ºæˆåŠŸï¼')
})
```

> æœ¬æ–‡çš„ç¤ºä¾‹ ğŸ‘‰ [åœ°å€](https://github.com/lio-zero/web-demos/blob/main/module-bundler/bundler.js)ã€‚
